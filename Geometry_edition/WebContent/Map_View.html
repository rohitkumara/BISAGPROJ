<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="http://localhost:8080/geoserver/openlayers3/ol.css" type="text/css">
    <style>
        #map {
            clear: both;
            position: relative;
            width: 768px;
            height: 755px;
            border: 1px solid black;
        }

    </style>
    <script src="http://localhost:8080/geoserver/openlayers3/ol.js" type="text/javascript"></script>
    <title>OpenLayers map preview</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>jQuery UI Dialog - Modal form</title>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="/resources/demos/style.css">
    <style>
        label, input { display:block; }
        input.text { margin-bottom:12px; width:95%; padding: .4em; }
        fieldset { padding:0; border:0; margin-top:25px; }
        h1 { font-size: 1.2em; margin: .6em 0; }
        div#users-contain { width: 350px; margin: 20px 0; }
        div#users-contain table { margin: 1em 0; border-collapse: collapse; width: 100%; }
        div#users-contain table td, div#users-contain table th { border: 1px solid #eee; padding: .6em 10px; text-align: left; }
        .ui-dialog .ui-state-error { padding: .3em; }
        .validateTips { border: 1px solid transparent; padding: 0.3em; }
    </style>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        var nam,note;
        $( function() {

            var dialog, form,n,

                // From http://www.whatwg.org/specs/web-apps/current-work/multipage/states-of-the-type-attribute.html#e-mail-state-%28type=email%29

                name = $( "#name" ),
                notes = $( "#notes" ),

                allFields = $( [] ).add( name ).add( notes ),
                tips = $( ".validateTips" );

            function updateTips( t ) {
                tips
                    .text( t )
                    .addClass( "ui-state-highlight" );
                setTimeout(function() {
                    tips.removeClass( "ui-state-highlight", 1500 );
                }, 500 );
            }





            function addInfo() {
                nam = name.val();
                note = notes.val();
                var temp = confirm("Do you want to proceed? Changes will be commited to the database.");
                if(temp){
                	submit_json();
                }
                else{}
                dialog.dialog( "close" );
            }

            dialog = $( "#dialog-form" ).dialog({
                autoOpen: false,
                height: 400,
                width: 350,
                modal: true,
                buttons: {
                    "Create new info": addInfo,
                    Cancel: function() {
                        dialog.dialog( "close" );
                    }
                },
                close: function() {
                    form[ 0 ].reset();
                    allFields.removeClass( "ui-state-error" );
                }
            });

            form = dialog.find( "form" ).on( "submit", function( event ) {
                event.preventDefault();
                addInfo();
            });

            $( "#createInfo" ).button().on( "click", function() {
                dialog.dialog( "open" );
            });
        } );
    </script>

</head>
<body>

<div id="map"></div>
<div id="wrapper">
    <div id="location"></div>
    <div id="scale">
    </div>
    <div id="nodelist">
        <em>Click on the map to get feature info</em>
    </div>

    <form class="form-inline">
        <label>Geometry type &nbsp;</label>
        <select id="type">
            <option value="Point">Point</option>
            <option value="LineString">LineString</option>
            <option value="Polygon">Polygon</option>
        </select>
        <input type="button" id="createInfo" value="submit"/>
    </form>

    <script type="text/javascript">
    	var geojson="lolgg";
        var routeFeatures;
        var format = 'image/jpeg';
        var bounds = [68.0401077270508, 6.61051988601685,
            97.5613098144531, 35.6450653076172];
	    
        
        var mousePositionControl = new ol.control.MousePosition({
            className: 'custom-mouse-position',
            target: document.getElementById('location'),
            coordinateFormat: ol.coordinate.createStringXY(5),
            undefinedHTML: '&nbsp;'
        });
        var untiled = new ol.layer.Image({
            source: new ol.source.ImageWMS({
                ratio: 1,
                url: 'http://localhost:8080/geoserver/testSQL/wms',
                params: {'FORMAT': format,
                    'VERSION': '1.1.1',
                    STYLES: '',
                    LAYERS: 'testSQL:testmore',
                }
            })
        });
        var untiled2 = new ol.layer.Image({
            source: new ol.source.ImageWMS({
                ratio: 1,
                url: 'http://localhost:8080/geoserver/testSQL/wms',
                params: {'FORMAT': format,
                    'VERSION': '1.1.1',
                    STYLES: '',
                    LAYERS: 'testSQL:features',
                }
            })
        });
        var projection = new ol.proj.Projection({
            code: 'EPSG:4326',
            units: 'degrees',
            axisOrientation: 'neu',
            global: true
        });
        var map = new ol.Map({
            controls: ol.control.defaults({
                attribution: false
            }).extend([mousePositionControl]),
            target: 'map',
            layers: [
                untiled
            ],
            view: new ol.View({
                projection: projection
            })
        });
		
        $.get('http://localhost:8081/Geometry_edition/return_json', function(responseText) {
        	var json = JSON.parse(responseText);
        	console.log(json);
        	var vecsource = new ol.source.Vector();
        	var gjson = new ol.format.GeoJSON();
        	gjson.readFeatures({
        		source:gjson
        	});
        	console.log(gjson);
        	vecsource.addFeatures();
        	var vectorlay = new ol.layer.Vector({
        		source: vecsource,
        		extent: bounds
        	});
        	map.addLayer(vectorlay);	
        });
        
        
        map.getView().on('change:resolution', function(evt) {
            var resolution = evt.target.get('resolution');
            var units = map.getView().getProjection().getUnits();
            var dpi = 25.4 / 0.28;
            var mpu = ol.proj.METERS_PER_UNIT[units];
            var scale = resolution * mpu * 39.37 * dpi;
            if (scale >= 9500 && scale <= 950000) {
                scale = Math.round(scale / 1000) + "K";
            } else if (scale >= 950000) {
                scale = Math.round(scale / 1000000) + "M";
            } else {
                scale = Math.round(scale);
            }
            document.getElementById('scale').innerHTML = "Scale = 1 : " + scale;
        });
        map.getView().fit(bounds, map.getSize());

        var features = new ol.Collection();
        var featureOverlay = new ol.layer.Vector({
            source: new ol.source.Vector({features: features}),
            style: new ol.style.Style({
                fill: new ol.style.Fill({
                    color: 'rgba(255, 255, 255, 0.2)'
                }),
                stroke: new ol.style.Stroke({
                    color: '#ffcc33',
                    width: 2
                }),
                image: new ol.style.Circle({
                    radius: 7,
                    fill: new ol.style.Fill({
                        color: '#ffcc33'
                    })
                })
            })
        });
        featureOverlay.setMap(map);

        var modify = new ol.interaction.Modify({
            features: features,
            // the SHIFT key must be pressed to delete vertices, so
            // that new vertices can be drawn at the same position
            // of existing vertices
            deleteCondition: function(event) {
                return ol.events.condition.shiftKeyOnly(event) &&
                    ol.events.condition.singleClick(event);
            }
        });
        map.addInteraction(modify);

        var draw; // global so we can remove it later
        var typeSelect = document.getElementById('type');

        function addInteraction() {
            draw = new ol.interaction.Draw({
                features: features,
                type: /** @type {ol.geom.GeometryType} */ (typeSelect.value)
            });
            map.addInteraction(draw);
        }


        /**
         * Handle change event.
         */
        typeSelect.onchange = function() {
            map.removeInteraction(draw);
            addInteraction();
        };

        addInteraction();

        function get_WKT(){
            var allFeatures = featureOverlay.getSource().getFeatures();
            var format = new ol.format.WKT();
            routeFeatures = format.writeFeatures(allFeatures);
            console.log(routeFeatures);
        }

        function submit_json() {
            get_WKT();
            var request = new XMLHttpRequest();
            request.open("POST", "http://localhost:8081/Geometry_edition/Geom_servlet?top=" + routeFeatures + "&name="+ nam +"&notes="+ note, true);
            request.send();
        }



    </script>
</div>

<div id="dialog-form" title="Create Info">
    <p class="validateTips">All form fields are required.</p>

    <form>
        <fieldset>
            <label for="name">Name</label>
            <input type="text" name="name" id="name"  class="text ui-widget-content ui-corner-all">
            <label for="notes">Notes</label>
            <input type="text" name="notes" id="notes" class="text ui-widget-content ui-corner-all">


            <!-- Allow form submission with keyboard without duplicating the dialog button -->
            <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
        </fieldset>
    </form>
</div>
</body>
</html>
